<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°–∞—Ä—ã”©–∑–µ–∫ –¢–∞–∫—Å–∏</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAqhj_A7f6GtpK-swJCDbSjne5zdy2XnAE",
      authDomain: "saryozek-taxi.firebaseapp.com",
      projectId: "saryozek-taxi",
      storageBucket: "saryozek-taxi.appspot.com",
      messagingSenderId: "758286199664",
      appId: "1:758286199664:web:a0b88b3b9c1316f878fdb5",
      measurementId: "G-7PMSMGB7K3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function getLocation(callback) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => callback({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
          err => {
            alert("‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞. –ó–∞–∫–∞–∑ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.");
            callback(null);
          }
        );
      } else {
        alert("‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
        callback(null);
      }
    }

    window.onload = () => {
      if (!window.Telegram || !window.Telegram.WebApp || !Telegram.WebApp.initDataUnsafe?.user) {
        document.body.innerHTML = "<h2 style='color:red; text-align:center; padding:40px;'>üö´ –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.</h2>";
        return;
      }

      Telegram.WebApp.ready();

      document.getElementById("orderBtn").addEventListener("click", async () => {
        const from = document.getElementById("from").value.trim();
        const to = document.getElementById("to").value.trim();

        if (!from) {
          alert("‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è.");
          return;
        }

        getLocation(async location => {
          if (!location) return;

          const telegramId = Telegram.WebApp.initDataUnsafe.user.id.toString();
          const phone = new URLSearchParams(window.location.search).get("phone") || "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω";

          const order = {
            from,
            to,
            location: {
              lat: location.latitude,
              lng: location.longitude
            },
            clientId: telegramId,
            phone: phone,
            type: "saryozek",
            createdAt: new Date().toISOString()
          };

          try {
            await setDoc(doc(db, "orders", telegramId), order);
            alert("‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!");
          } catch (e) {
            alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –≤ Firebase");
            console.error(e);
          }
        });
      });
    };
  </script>
</head>
<body style="font-family:sans-serif; padding:20px;">
  <h2>üöï –ó–∞–∫–∞–∑ —Ç–∞–∫—Å–∏ ‚Äî –°–∞—Ä—ã”©–∑–µ–∫</h2>
  <label>–û—Ç–∫—É–¥–∞:</label>
  <input type="text" id="from" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≤–æ–∑–ª–µ –¶–û–ù" />

  <label>–ö—É–¥–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
  <input type="text" id="to" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–∞–∑–∞—Ä" />

  <button id="orderBtn" style="margin-top:20px; padding:12px; font-size:16px;">üöñ –ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏</button>
</body>
</html>
